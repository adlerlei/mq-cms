<!doctype html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Media Display - MQAD</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        .carousel-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .carousel-item {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .carousel-item.active {
            opacity: 1;
        }

        .carousel-item img,
        .carousel-item video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .carousel-item video {
            width: 100%;
            height: 100%;
        }

        .loading-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-size: 2rem;
            color: #fff;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 1000;
        }

        .connection-status.connected {
            background: rgba(0, 255, 0, 0.8);
            color: #000;
        }

        .connection-status.disconnected {
            background: rgba(255, 0, 0, 0.8);
            color: #fff;
        }

        .playlist-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 1000;
        }

        /* å»£æ’­è¨Šæ¯æ¨£å¼ */
        .broadcast-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px 50px;
            border-radius: 15px;
            font-size: 2rem;
            text-align: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            max-width: 80%;
            word-wrap: break-word;
        }

        .broadcast-message.show {
            opacity: 1;
        }

        .broadcast-message.is-primary {
            background: rgba(0, 123, 255, 0.9);
        }

        .broadcast-message.is-success {
            background: rgba(40, 167, 69, 0.9);
        }

        .broadcast-message.is-warning {
            background: rgba(255, 193, 7, 0.9);
            color: #000;
        }

        .broadcast-message.is-danger {
            background: rgba(220, 53, 69, 0.9);
        }
    </style>
</head>
<body>
    <div class="carousel-container" id="carouselContainer">
        <div class="loading-message" id="loadingMessage">
            è¼‰å…¥åª’é«”æª”æ¡ˆä¸­...
        </div>
    </div>

    <div class="connection-status disconnected" id="connectionStatus">
        WebSocket é€£æ¥ä¸­...
    </div>

    <div class="playlist-info" id="playlistInfo">
        æ’­æ”¾åˆ—è¡¨: è¼‰å…¥ä¸­...
    </div>

    <div class="broadcast-message" id="broadcastMessage"></div>

    <script>
        class MediaCarousel {
            constructor() {
                this.playlist = [];
                this.currentIndex = 0;
                this.carouselContainer = document.getElementById('carouselContainer');
                this.loadingMessage = document.getElementById('loadingMessage');
                this.playlistInfo = document.getElementById('playlistInfo');
                this.connectionStatus = document.getElementById('connectionStatus');
                this.broadcastMessage = document.getElementById('broadcastMessage');
                this.websocket = null;
                this.slideInterval = null;
                this.R2_BASE_URL = 'https://pub-28f2148e4e2940c58f29c6f5147a004b.r2.dev';
                
                this.init();
            }

            async init() {
                console.log('ğŸš€ Initializing Media Carousel');
                await this.loadPlaylist();
                this.connectWebSocket();
            }

            async loadPlaylist() {
                try {
                    console.log('ğŸ“‹ Loading playlist from API...');
                    const response = await fetch('/api/media');
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const files = await response.json();
                    console.log('âœ… Playlist loaded:', files);
                    
                    // éæ¿¾å‡ºåœ–ç‰‡å’Œå½±ç‰‡æª”æ¡ˆ
                    this.playlist = files.filter(filename => {
                        const ext = filename.toLowerCase().split('.').pop();
                        return ['jpg', 'jpeg', 'png', 'gif', 'webp', 'mp4', 'webm', 'mov', 'avi'].includes(ext);
                    });

                    this.updatePlaylistInfo();
                    this.buildCarousel();
                    
                } catch (error) {
                    console.error('âŒ Error loading playlist:', error);
                    this.showError('ç„¡æ³•è¼‰å…¥æ’­æ”¾åˆ—è¡¨');
                }
            }

            updatePlaylistInfo() {
                const count = this.playlist.length;
                this.playlistInfo.textContent = `æ’­æ”¾åˆ—è¡¨: ${count} å€‹åª’é«”æª”æ¡ˆ`;
            }

            buildCarousel() {
                // æ¸…ç©ºç¾æœ‰å…§å®¹
                this.carouselContainer.innerHTML = '';
                
                if (this.playlist.length === 0) {
                    this.carouselContainer.innerHTML = '<div class="loading-message">æ²’æœ‰å¯æ’­æ”¾çš„åª’é«”æª”æ¡ˆ</div>';
                    return;
                }

                console.log('ğŸ  Building carousel with', this.playlist.length, 'items');

                // ç‚ºæ¯å€‹åª’é«”æª”æ¡ˆå‰µå»ºè¼ªæ’­é …ç›®
                this.playlist.forEach((filename, index) => {
                    const item = document.createElement('div');
                    item.className = 'carousel-item';
                    if (index === 0) item.classList.add('active');

                    const mediaUrl = `${this.R2_BASE_URL}/${filename}`;
                    const ext = filename.toLowerCase().split('.').pop();

                    if (['mp4', 'webm', 'mov', 'avi'].includes(ext)) {
                        // å½±ç‰‡
                        const video = document.createElement('video');
                        video.src = mediaUrl;
                        video.autoplay = true;
                        video.muted = true;
                        video.loop = false;
                        video.controls = false;
                        
                        video.addEventListener('ended', () => {
                            this.nextSlide();
                        });
                        
                        video.addEventListener('error', (e) => {
                            console.error('âŒ Video load error:', filename, e);
                        });

                        item.appendChild(video);
                    } else {
                        // åœ–ç‰‡
                        const img = document.createElement('img');
                        img.src = mediaUrl;
                        img.alt = filename;
                        
                        img.addEventListener('error', (e) => {
                            console.error('âŒ Image load error:', filename, e);
                        });

                        item.appendChild(img);
                    }

                    this.carouselContainer.appendChild(item);
                });

                this.startSlideshow();
            }

            startSlideshow() {
                // æ¸…é™¤ç¾æœ‰çš„å®šæ™‚å™¨
                if (this.slideInterval) {
                    clearInterval(this.slideInterval);
                }

                // åªæœ‰åœ–ç‰‡éœ€è¦è‡ªå‹•è¼ªæ’­ï¼Œå½±ç‰‡æœƒåœ¨æ’­æ”¾çµæŸæ™‚è‡ªå‹•åˆ‡æ›
                this.slideInterval = setInterval(() => {
                    const currentItem = this.carouselContainer.children[this.currentIndex];
                    const isVideo = currentItem && currentItem.querySelector('video');
                    
                    // å¦‚æœç•¶å‰æ˜¯åœ–ç‰‡ï¼Œå‰‡è‡ªå‹•åˆ‡æ›åˆ°ä¸‹ä¸€å¼µ
                    if (!isVideo) {
                        this.nextSlide();
                    }
                }, 5000); // åœ–ç‰‡é¡¯ç¤º 5 ç§’
            }

            nextSlide() {
                if (this.playlist.length === 0) return;

                // éš±è—ç•¶å‰é …ç›®
                const currentItem = this.carouselContainer.children[this.currentIndex];
                if (currentItem) {
                    currentItem.classList.remove('active');
                    
                    // å¦‚æœæ˜¯å½±ç‰‡ï¼Œæš«åœæ’­æ”¾
                    const video = currentItem.querySelector('video');
                    if (video) {
                        video.pause();
                        video.currentTime = 0;
                    }
                }

                // ç§»å‹•åˆ°ä¸‹ä¸€å€‹é …ç›®
                this.currentIndex = (this.currentIndex + 1) % this.playlist.length;

                // é¡¯ç¤ºæ–°é …ç›®
                const nextItem = this.carouselContainer.children[this.currentIndex];
                if (nextItem) {
                    nextItem.classList.add('active');
                    
                    // å¦‚æœæ˜¯å½±ç‰‡ï¼Œé–‹å§‹æ’­æ”¾
                    const video = nextItem.querySelector('video');
                    if (video) {
                        video.play().catch(e => {
                            console.error('âŒ Video play error:', e);
                        });
                    }
                }

                console.log(`ğŸ¬ Switched to slide ${this.currentIndex + 1}/${this.playlist.length}`);
            }

            connectWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws`;
                
                console.log('ğŸ”Œ Connecting to WebSocket:', wsUrl);
                
                this.websocket = new WebSocket(wsUrl);

                this.websocket.onopen = () => {
                    console.log('âœ… WebSocket connected');
                    this.connectionStatus.textContent = 'WebSocket å·²é€£æ¥';
                    this.connectionStatus.className = 'connection-status connected';
                };

                this.websocket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('ğŸ“¨ WebSocket message received:', data);
                        
                        if (data.type === 'playlist_updated') {
                            console.log('ğŸ”„ Playlist updated, reloading...');
                            this.loadPlaylist();
                        } else if (data.content) {
                            // é¡¯ç¤ºå»£æ’­è¨Šæ¯
                            this.showBroadcastMessage(data.content, data.style);
                        }
                    } catch (error) {
                        console.error('âŒ Error parsing WebSocket message:', error);
                    }
                };

                this.websocket.onclose = () => {
                    console.log('âŒ WebSocket disconnected');
                    this.connectionStatus.textContent = 'WebSocket å·²æ–·ç·š';
                    this.connectionStatus.className = 'connection-status disconnected';
                    
                    // 5ç§’å¾Œé‡æ–°é€£æ¥
                    setTimeout(() => {
                        this.connectWebSocket();
                    }, 5000);
                };

                this.websocket.onerror = (error) => {
                    console.error('âŒ WebSocket error:', error);
                };
            }

            showBroadcastMessage(content, style = 'is-info') {
                this.broadcastMessage.textContent = content;
                this.broadcastMessage.className = `broadcast-message ${style} show`;
                
                // 5ç§’å¾Œéš±è—è¨Šæ¯
                setTimeout(() => {
                    this.broadcastMessage.classList.remove('show');
                }, 5000);
            }

            showError(message) {
                this.carouselContainer.innerHTML = `<div class="loading-message">âŒ ${message}</div>`;
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–è¼ªæ’­å™¨
        document.addEventListener('DOMContentLoaded', () => {
            new MediaCarousel();
        });
    </script>
</body>
</html>